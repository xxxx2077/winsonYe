
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>Backend notice - winsonYe</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35f28582.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#backend-notice" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="winsonYe" class="md-header__button md-logo" aria-label="winsonYe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            winsonYe
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Backend notice
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="winsonYe" class="md-nav__button md-logo" aria-label="winsonYe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    winsonYe
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    开发
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    后端开发
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            后端开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../interview_experiences/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    面经
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    算法题
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            算法题
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algorithm/algorithm_basic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    算法基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../algorithm/leetcode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    leetcode刷题笔记
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#topic-1" class="md-nav__link">
    <span class="md-ellipsis">
      Topic 1: 加水印
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Topic 1: 加水印">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem-1" class="md-nav__link">
    <span class="md-ellipsis">
      Problem 1: 加水印大小自适应问题
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-1pdf" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 1：单线程创建自适应pdf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problem-2" class="md-nav__link">
    <span class="md-ellipsis">
      Problem 2：加水印过慢
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-2pdf" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 2：多线程创建自适应pdf
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-3" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 3：只考虑两种情况
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-4-lru" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 4: LRU优化下载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution-5" class="md-nav__link">
    <span class="md-ellipsis">
      Solution 5: 等你解决
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#topic-2exception" class="md-nav__link">
    <span class="md-ellipsis">
      Topic 2：Exception
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Topic 2：Exception">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem" class="md-nav__link">
    <span class="md-ellipsis">
      Problem：
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution：
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#topic-3es-search" class="md-nav__link">
    <span class="md-ellipsis">
      Topic 3：ES search
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Topic 3：ES search">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#problem-mustshould" class="md-nav__link">
    <span class="md-ellipsis">
      Problem: must和should冲突
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#solution_1" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="backend-notice">Backend notice</h1>
<blockquote>
<p>本文档介绍后端开发中遇到的问题和解决方法/经验</p>
</blockquote>
<h2 id="topic-1">Topic 1: 加水印</h2>
<h3 id="problem-1">Problem 1: 加水印大小自适应问题</h3>
<p>实现加水印过程中，我们发现用户的文件页面大小不一（比如在同一个pdf中，存在页面非常大的封面页和页面正常的内容也），不能仅仅通过创建一个水印页面适用于所有页面，否则会造成水印位置偏移等水印效果不好的情况</p>
<p>对于这种情况，我们尝试了多个办法</p>
<h3 id="solution-1pdf">Solution 1：单线程创建自适应pdf</h3>
<blockquote>
<p>相关代码在<code>create_watermark_adapted_singleThread</code>和<code>add_watermark_file_singleThread</code></p>
</blockquote>
<p>我们尝试创建一个多页的水印pdf，该pdf每一页的大小与对应输入pdf的每一页大小相同，从而实现自适应</p>
<p>代码示例如下：</p>
<p>思路为：将多个水印页面合并在一个pdf内</p>
<pre><code class="language-python">    for i in range(pageNum):
        page = pdf_input.getPage(i)
        page_width = float(page.mediaBox.getWidth())
        page_height = float(page.mediaBox.getHeight())
        pageSize=(page_width,page_height)
        pdf_watermark_data=create_watermark(content,pageSize)
        pdf_watermark_singleFile = PdfFileReader(BytesIO(pdf_watermark_data), strict=False)
        pdf_watermark_singleFilePage = pdf_watermark_singleFile.getPage(0)
        pdf_watermark_singleFilePage.compressContentStreams()
        pdf_watermark_file.addPage(pdf_watermark_singleFilePage)
</code></pre>
<h3 id="problem-2">Problem 2：加水印过慢</h3>
<p>解法1能解决自适应水印页面问题，但会造成加水印速度过慢，于是我们想通过多线程加速</p>
<h3 id="solution-2pdf">Solution 2：多线程创建自适应pdf</h3>
<blockquote>
<p>相关代码在<code>create_watermark_adapted_multiThread</code>和<code>add_watermark_file_multiThread</code></p>
</blockquote>
<p>我们通过创建线程池，对创建水印的行为进行并行操作</p>
<pre><code class="language-python">page_results=pool.map(create_watermark_adapted_multiThread,content_list,page_list)  
</code></pre>
<p>遗憾的是，我们发现线程池并不会显著加速加水印（仅仅加速了3s，对于60s的总时间来说显然不够）</p>
<p>通过测速，我们发现时间主要消耗：将水印文件和输入文件合并的操作中的addPage函数，由于需要保障输出文件的有序性，addPage无法避免，因此我们也放弃了这种方法</p>
<h3 id="solution-3">Solution 3：只考虑两种情况</h3>
<blockquote>
<p>相关代码在<code>create_watermark</code></p>
</blockquote>
<p>相比于之前的方法，我们最后为了缩短下载时间选择了不那么全面的解法：我们暂时只考虑两种情况（书籍PDF和普通PDF）</p>
<p>书籍PDF有个显著特点：前两页为封面页，页面比较大；后面为内容页，页面比较小</p>
<p>普通PDF则全部页面大小都相同</p>
<p>因此我们用以下代码解决以上两种情况：</p>
<p>我们只取第一页和第三页，对其大小进行比较，取最小页面大小，从而实现水印兼容</p>
<p>由于水印文件只有一页，所以大大缩短了加水印的时间</p>
<pre><code># 获得封面页尺寸
    page = pdf_input.getPage(0)
    page_width = float(page.mediaBox.getWidth())
    page_height = float(page.mediaBox.getHeight())
    pageSize=(page_width,page_height)

    if pageNum &gt; 3:
        page = pdf_input.getPage(0)
        page_width = min(page_width,float(page.mediaBox.getWidth()))
        page_height = min(page_height,float(page.mediaBox.getHeight()))
        pageSize=(page_width,page_height)
</code></pre>
<h3 id="solution-4-lru">Solution 4: LRU优化下载</h3>
<p>我们发现下载文件也是个非常耗时的过程，但这个主要是因为网速太慢。为了优化下载的时间，我们选择使用LRU算法实现下载API。</p>
<p>LRU原理如下链接：</p>
<p><a href="https://blog.csdn.net/belongtocode/article/details/102989685">全面讲解LRU算法-CSDN博客</a></p>
<h3 id="solution-5">Solution 5: 等你解决</h3>
<p>看看后来人有没有办法能够更好地解决</p>
<h2 id="topic-2exception">Topic 2：<code>Exception</code></h2>
<h3 id="problem">Problem：</h3>
<p>如果按下面代码执行，会出现直接触发<code>except Exception as e</code>中的<code>Exception</code>，导致无法显示正确的报错信息</p>
<pre><code class="language-python">    try:
            bucket_name = BUCKET_NAME
            # 读取要加水印的文件
            pdf_data = minio_messenger.download(bucket_name, fuuid).read()
            if pdf_data is None:
                raise response_400(data='下载文件失败') 
            pdf_size = len(pdf_data)

            pdf_input = PdfFileReader(BytesIO(pdf_data), strict=False)
            if pdf_input is None:
                raise response_400(data='下载文件读取失败') 

            # 编辑水印内容
            mark_content = current_user.nickName+current_user.phone

            if pdf_size &lt;= ignore_watermark*1024*1024:
                # 创建水印
                create_watermark(pdf_input,mark_content,fuuid,current_user.SNo)                              
                return response_200(data='水印已添加')
            else:
                # 对输出文件命名
                output_filename = f'{fuuid}_{current_user.SNo}_output.pdf'
                output_filepath = os.path.join(os.path.dirname(__file__), f'../../watermark/{output_filename}')
                with open(output_filepath,'wb') as output_file:
                    # 将 PdfFileWriter 中的页面写入到 BytesIO 对象
                    output_file.write(pdf_data)
                return response_200(data='不需要添加水印')
    except Exception as e:
        raise response_400(data = str(e))
</code></pre>
<p>例如：</p>
<pre><code class="language-python">pdf_data = minio_messenger.download(bucket_name, fuuid).read()
    if pdf_data is None:
       raise response_400(data='下载文件失败') 
</code></pre>
<p>如果download失败不会返回错误信息'下载文件失败'，而是直接返回系统自己报的错误（通常是英文），表示没有成功raise response</p>
<h3 id="solution">Solution：</h3>
<p>我们添加一个捕获自定义<code>HTTPException</code>的代码，当代码遇到特定判断时，会raise response（response核心是返回<code>HTTPException</code>），所以这段代码会捕获response，然后将其返回这个response</p>
<p>如果按上面Problem的写法，会导致<code>Exception</code>里面有<code>response_400</code>，自然不会报<code>response_400</code></p>
<pre><code class="language-python">    # 不拦截自定义的HTTPException
    except HTTPException as e:
        raise e
</code></pre>
<p>完整代码如下：</p>
<pre><code class="language-python">    try:
            bucket_name = BUCKET_NAME
            # 读取要加水印的文件
            pdf_data = minio_messenger.download(bucket_name, fuuid).read()
            if pdf_data is None:
                raise response_400(data='下载文件失败') 
            pdf_size = len(pdf_data)

            pdf_input = PdfFileReader(BytesIO(pdf_data), strict=False)
            if pdf_input is None:
                raise response_400(data='下载文件读取失败') 

            # 编辑水印内容
            mark_content = current_user.nickName+current_user.phone

            if pdf_size &lt;= ignore_watermark*1024*1024:
                # 创建水印
                create_watermark(pdf_input,mark_content,fuuid,current_user.SNo)                              
                return response_200(data='水印已添加')
            else:
                # 对输出文件命名
                output_filename = f'{fuuid}_{current_user.SNo}_output.pdf'
                output_filepath = os.path.join(os.path.dirname(__file__), f'../../watermark/{output_filename}')
                with open(output_filepath,'wb') as output_file:
                    # 将 PdfFileWriter 中的页面写入到 BytesIO 对象
                    output_file.write(pdf_data)
                return response_200(data='不需要添加水印')
    # 不拦截自定义的HTTPException
    except HTTPException as e:
        raise e
    # 拦截预料之外的异常
    except Exception as e:
        raise response_400(data = str(e))
</code></pre>
<h2 id="topic-3es-search">Topic 3：<code>ES search</code></h2>
<h3 id="problem-mustshould">Problem: must和should冲突</h3>
<p>这是一开始的写法</p>
<p>我们发现搜索的时候只满足了must的条件，而should似乎被忽略了</p>
<pre><code>body = {
                # 当前页数据的起始位置=页码（从0开始）*每页数据条数
                &quot;from&quot;: page*10,
                # 每页查询的数据条数
                &quot;size&quot;: 10, 
                &quot;query&quot;: {
                    &quot;bool&quot;: {
                        &quot;must&quot;: [
                            { &quot;term&quot;: {&quot;fCate&quot;: type } }
                        ]                
                        &quot;should&quot;: [ 
                             { &quot;match&quot;: {&quot;fName&quot;: keyword } },
                             { &quot;match&quot;: {&quot;fIntro&quot;: keyword } },
                             { &quot;match&quot;: {&quot;fTag&quot;: keyword } }
                        ]}
                    }
                }
</code></pre>
<p>查网发现，must和should不能同级，正如<code>a==1&amp;&amp;b==1||b==2</code>不能用于表示“满足a==1的前提下，b取1或2”，而是改为<code>a==1&amp;&amp;(b==1||b==2)</code>；</p>
<p>即must和should不能同级正如&amp;&amp;和||不能同级</p>
<h3 id="solution_1">Solution</h3>
<pre><code class="language-python">body = {
                # 当前页数据的起始位置=页码（从0开始）*每页数据条数
                &quot;from&quot;: page*10,
                # 每页查询的数据条数
                &quot;size&quot;: 10, 
                &quot;query&quot;: {
                    &quot;bool&quot;: {
                        &quot;must&quot;: [
                            { &quot;term&quot;: {&quot;fCate&quot;: type } },
                            {
                                &quot;bool&quot;:{
                                    &quot;should&quot;: [ 
                                        { &quot;match&quot;: {&quot;fName&quot;: keyword } },
                                        { &quot;match&quot;: {&quot;fIntro&quot;: keyword } },
                                        { &quot;match&quot;: {&quot;fTag&quot;: keyword } }
                                ]}
                            }
                        ]                
                    }
                }
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>